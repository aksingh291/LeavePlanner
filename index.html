<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Leave Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Libraries for PDF file generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .calendar-day:not(.disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .message-enter {
            opacity: 0;
            transform: translateY(-10px);
        }
        .message-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms, transform 300ms;
        }
        .employee-entry {
            cursor: pointer;
        }
        #tooltip {
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            pointer-events: none;
            transform: scale(0.95);
        }
        #tooltip.visible {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 bg-white z-50 flex flex-col lg:flex-row transition-opacity duration-300">
        <!-- Decorative Left Side -->
        <div class="relative w-full h-64 lg:h-full lg:w-1/2 flex items-center justify-center bg-gradient-to-br from-slate-800 to-slate-900 text-white p-8 lg:p-12">
            <div class="absolute inset-0 opacity-10 bg-[url('data:image/svg+xml,%3Csvg%20width%3D%2260%22%20height%3D%2260%22%20viewBox%3D%220%200%2060%2060%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cg%20fill%3D%22none%22%20fill-rule%3D%22evenodd%22%3E%3Cg%20fill%3D%22%23ffffff%22%20fill-opacity%3D%220.4%22%3E%3Cpath%20d%3D%22M36%2034v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6%2034v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6%204V0H4v4H0v2h4v4h2V6h4V4H6z%22/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')]"></div>
            <div class="relative z-10 text-center">
                <div class="mx-auto h-16 w-16 mb-4 text-sky-400">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold">Welcome Back</h2>
                <p class="mt-2 max-w-sm mx-auto opacity-80">Your team's schedule, organized and accessible. Sign in to manage and view time off.</p>
            </div>
        </div>

        <!-- Form Right Side -->
        <div class="w-full lg:w-1/2 flex items-center justify-center bg-gray-50 p-8 sm:p-12">
            <div class="w-full max-w-md">
                <div class="text-center lg:text-left mb-10">
                    <h1 class="text-3xl font-bold text-gray-900">Marketplace India Team Leave Planner</h1>
                    <p class="mt-2 text-sm text-gray-500">Please validate your User ID to continue.</p>
                </div>
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="userIdInput" class="block text-sm font-medium text-gray-700">User ID</label>
                        <div class="mt-1 relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                </svg>
                            </span>
                            <input id="userIdInput" placeholder="work_email" name="userid" type="text" autocomplete="off" required class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <button type="button" id="validateBtn" class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-800 hover:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-transform transform hover:scale-105">
                            Validate
                        </button>
                        <button type="button" id="viewPlannerBtn" class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 hidden transition-transform transform hover:scale-105">
                            View Planner
                        </button>
                    </div>
                    <p id="loginMessage" class="text-center text-sm font-medium"></p>
                </form>
            </div>
        </div>
    </div>

    <div id="app" class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl hidden">
        <!-- Header Section -->
        <header class="text-center mb-10 flex items-center justify-center gap-4">
            <div class="h-12 w-12 text-blue-600">
               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                 <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
               </svg>
            </div>
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">MarketPlace India Team Leave Planner</h1>
                <p class="mt-1 text-md text-gray-500">Plan your team's time off.</p>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column Container -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Leave Request Form -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 h-fit relative">
                    <div id="formLoadingOverlay" class="absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center rounded-xl z-10">
                        <p class="text-gray-600 font-semibold animate-pulse">Connecting...</p>
                    </div>
                    <h2 id="formTitle" class="text-xl font-semibold mb-4 text-gray-800">Request Leave</h2>
                    <form id="leaveForm" class="space-y-4">
                        <div>
                            <label for="employeeName" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                            <input type="text" id="employeeName" placeholder="Enter full name" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition disabled:bg-gray-100">
                        </div>
                        <div>
                            <label for="leaveDate" class="block text-sm font-medium text-gray-700 mb-1">Leave Date</label>
                            <input type="date" id="leaveDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                        <div>
                            <label for="leaveType" class="block text-sm font-medium text-gray-700 mb-1">Leave Type</label>
                            <select id="leaveType" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                <option value="P">P - Planned</option>
                                <option value="S">S - Sick</option>
                                <option value="H">H - Holiday</option>
                                <option value="C">C - Casual</option>
                            </select>
                        </div>
                        <div class="flex space-x-2 pt-2">
                            <button type="submit" id="submitButton" class="w-full bg-slate-800 text-white font-semibold py-2.5 px-4 rounded-md hover:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-transform transform hover:scale-105">
                                Submit Request
                            </button>
                            <button type="button" id="cancelButton" class="w-full bg-gray-200 text-gray-700 font-semibold py-2.5 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition hidden">
                                Cancel
                            </button>
                        </div>
                    </form>
                    <!-- Message Box for notifications -->
                    <div id="messageBox" class="mt-4 text-sm font-medium"></div>
                </div>

                <!-- Leave Summary -->
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 h-fit">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Leave Summary</h2>
                    <div id="leaveSummary" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                        <p class="text-gray-500 animate-pulse">Loading summary...</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Calendar View -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md border border-gray-100 relative">
                 <div id="calendarLoadingOverlay" class="absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center rounded-xl z-10">
                    <p class="text-gray-600 font-semibold animate-pulse">Loading Calendar...</p>
                </div>
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-100 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h2 id="currentMonthYear" class="text-xl md:text-2xl font-bold text-gray-800 w-48 text-center"></h2>
                        <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-100 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div>
                        <button id="downloadPdfButton" class="flex items-center space-x-2 bg-slate-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-transform transform hover:scale-105">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd"><path d="M.022 0h19.956v20H.022V0zm8.978 14.823V5.5h2v9.323l3.3-3.3.707.707-4.5 4.5-4.5-4.5.707-.707 3.3 3.3z"/></svg>
                            <span class="hidden sm:inline">Download Report</span>
                        </button>
                    </div>
                </div>
                
                <div id="calendar-header" class="grid grid-cols-7 gap-2 text-center text-xs sm:text-sm font-semibold text-gray-500 mb-2">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-1 md:gap-2"></div>
            </div>
        </main>
    </div>
    
    <div id="tooltip" class="fixed opacity-0 z-10 p-3 bg-gray-800 text-white border border-gray-300 rounded-lg shadow-xl text-sm w-48"></div>

    <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                     <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900 mt-2">Confirmation Required</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modalMessage" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3 space-x-2">
                    <button id="modalConfirmBtn" class="px-4 py-2 bg-slate-800 text-white text-base font-medium rounded-md w-auto hover:bg-slate-900">Yes, Proceed</button>
                    <button id="modalCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto hover:bg-gray-300">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, updateDoc, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', () => {

            // --- LOGIN UI ELEMENTS ---
            const loginOverlay = document.getElementById('loginOverlay');
            const appContainer = document.getElementById('app');
            const loginForm = document.getElementById('loginForm');
            const userIdInput = document.getElementById('userIdInput');
            const validateBtn = document.getElementById('validateBtn');
            const viewPlannerBtn = document.getElementById('viewPlannerBtn');
            const loginMessage = document.getElementById('loginMessage');

            // --- LOGIN LOGIC ---
            loginForm.addEventListener('submit', (e) => e.preventDefault());

            const validateUserId = () => {
                const userId = userIdInput.value.trim().toLowerCase();
                if (userId.endsWith('@intuit.com')) {
                    loginMessage.textContent = 'Validation successful. You can now view the planner.';
                    loginMessage.classList.remove('text-red-600');
                    loginMessage.classList.add('text-green-600');
                    validateBtn.classList.add('hidden');
                    viewPlannerBtn.classList.remove('hidden');
                } else {
                    loginMessage.textContent = 'Invalid User ID. Must end with @intuit.com';
                    loginMessage.classList.remove('text-green-600');
                    loginMessage.classList.add('text-red-600');
                    validateBtn.classList.remove('hidden');
                    viewPlannerBtn.classList.add('hidden');
                }
            };
            
            validateBtn.addEventListener('click', validateUserId);
            // Allow pressing Enter to validate
            userIdInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    validateUserId();
                }
            });

            viewPlannerBtn.addEventListener('click', () => {
                loginOverlay.classList.add('opacity-0');
                setTimeout(() => {
                    loginOverlay.classList.add('hidden');
                }, 300);
                appContainer.classList.remove('hidden');
                
                // Initialize the main app logic ONLY after validation
                initializeAppLogic();
            });


            // --- MAIN APP LOGIC ---
            async function initializeAppLogic() {
                // --- FIREBASE SETUP ---
                const userProvidedConfig = {
                    apiKey: "AIzaSyC3W-5IUN-htJtWY0-g1CMtniM0x5vj6W0",
                    authDomain: "team-leave-planner-1e2d5.firebaseapp.com",
                    projectId: "team-leave-planner-1e2d5",
                    storageBucket: "team-leave-planner-1e2d5.appspot.com",
                    messagingSenderId: "644468744907",
                    appId: "1:644468744907:web:65d26f5d7dcf3cf8b6f14e",
                    measurementId: "G-BL9569JE6E"
                };

                const firebaseConfig = typeof __firebase_config !== 'undefined'
                    ? JSON.parse(__firebase_config)
                    : userProvidedConfig;
                
                const appId = 'team-leave-planner-01';

                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                setLogLevel('debug');

                // --- STATE MANAGEMENT ---
                let currentDate = new Date();
                currentDate.setMonth(9); // October
                currentDate.setFullYear(2025);
                let currentMonth = currentDate.getMonth();
                let currentYear = currentDate.getFullYear();
                let editingLeave = null; 
                let leaves = [];
                let leavesCollectionPath;

                // --- DOM ELEMENT REFERENCES ---
                const form = document.getElementById('leaveForm');
                const formTitle = document.getElementById('formTitle');
                const nameInput = document.getElementById('employeeName');
                const dateInput = document.getElementById('leaveDate');
                const leaveTypeInput = document.getElementById('leaveType');
                const submitButton = document.getElementById('submitButton');
                const cancelButton = document.getElementById('cancelButton');
                const messageBox = document.getElementById('messageBox');
                const calendarGrid = document.getElementById('calendarGrid');
                const monthYearDisplay = document.getElementById('currentMonthYear');
                const prevBtn = document.getElementById('prevMonth');
                const nextBtn = document.getElementById('nextMonth');
                const downloadPdfButton = document.getElementById('downloadPdfButton');
                const tooltip = document.getElementById('tooltip');
                const confirmationModal = document.getElementById('confirmationModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalMessage = document.getElementById('modalMessage');
                const modalConfirmBtn = document.getElementById('modalConfirmBtn');
                const modalCancelBtn = document.getElementById('modalCancelBtn');
                const formLoadingOverlay = document.getElementById('formLoadingOverlay');
                const calendarLoadingOverlay = document.getElementById('calendarLoadingOverlay');
                const leaveSummaryContainer = document.getElementById('leaveSummary');

                // --- CORE FUNCTIONS (DEFINED BEFORE USE) ---
                const seedInitialData = async () => {
                    const leavesCollection = collection(db, leavesCollectionPath);
                    try {
                        const snapshot = await getDocs(leavesCollection);
                        if (snapshot.empty) {
                            console.log("Database is empty. Seeding initial data...");
                            const initialLeaves = [
                                { employeeName: "Sujithra", leaveDate: "2025-10-20", leaveType: "H" }, { employeeName: "Sujithra", leaveDate: "2025-10-23", leaveType: "P" },
                                { employeeName: "Deepshika", leaveDate: "2025-10-15", leaveType: "H" }, { employeeName: "Deepshika", leaveDate: "2025-10-20", leaveType: "H" }, { employeeName: "Deepshika", leaveDate: "2025-10-22", leaveType: "P" }, { employeeName: "Deepshika", leaveDate: "2025-10-28", leaveType: "P" },
                                { employeeName: "Vivek", leaveDate: "2025-10-21", leaveType: "H" }, { employeeName: "Vivek", leaveDate: "2025-10-22", leaveType: "H" }, { employeeName: "Vivek", leaveDate: "2025-11-01", leaveType: "P" }, { employeeName: "Vivek", leaveDate: "2025-11-02", leaveType: "P" },
                                { employeeName: "Surjeet", leaveDate: "2025-10-21", leaveType: "P" }, { employeeName: "Surjeet", leaveDate: "2025-10-22", leaveType: "P" }, { employeeName: "Surjeet", leaveDate: "2025-10-23", leaveType: "P" }, { employeeName: "Surjeet", leaveDate: "2025-10-24", leaveType: "P" }, { employeeName: "Surjeet", leaveDate: "2025-10-25", leaveType: "P" },
                                { employeeName: "Ravi", leaveDate: "2025-10-21", leaveType: "H" },
                                { employeeName: "Akshay", leaveDate: "2025-10-21", leaveType: "H" }, { employeeName: "Akshay", leaveDate: "2025-10-27", leaveType: "P" },
                                { employeeName: "Harshita", leaveDate: "2025-10-16", leaveType: "S" }, { employeeName: "Harshita", leaveDate: "2025-10-21", leaveType: "H" }, { employeeName: "Harshita", leaveDate: "2025-10-27", leaveType: "P" },
                                { employeeName: "Nilesh", leaveDate: "2025-10-21", leaveType: "H" },
                                { employeeName: "Monika", leaveDate: "2025-10-22", leaveType: "H" }, { employeeName: "Monika", leaveDate: "2025-10-23", leaveType: "P" }, { employeeName: "Monika", leaveDate: "2025-10-25", leaveType: "P" },
                            ];
                            for (const leave of initialLeaves) {
                                await addDoc(leavesCollection, leave);
                            }
                            console.log("Initial data seeded.");
                        } else {
                            console.log("Database already contains data. Skipping seed.");
                        }
                    } catch (error) {
                        console.error("Error checking or seeding data:", error);
                        throw error;
                    }
                };

                const renderLeaveSummary = () => {
                    const leaveCounts = {};
                    leaves.forEach(leave => {
                        const name = leave.employeeName;
                        if (!leaveCounts[name]) {
                            leaveCounts[name] = { leaves: 0, holidays: 0 };
                        }

                        if (leave.leaveType === 'H') {
                            leaveCounts[name].holidays++;
                        } else { // S, P, C
                            leaveCounts[name].leaves++;
                        }
                    });

                    const sortedNames = Object.keys(leaveCounts).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

                    if (sortedNames.length === 0) {
                        leaveSummaryContainer.innerHTML = '<p class="text-gray-500">No leave data found.</p>';
                        return;
                    }

                    leaveSummaryContainer.innerHTML = sortedNames.map(name => `
                        <div class="flex justify-between items-center text-sm py-2 border-b border-gray-100 last:border-b-0">
                            <span class="text-gray-700 font-medium">${name}</span>
                            <div class="flex items-center space-x-4">
                                <div class="text-right">
                                    <span class="text-xs text-gray-500">Leaves</span>
                                    <span class="font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full text-xs">${leaveCounts[name].leaves}</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs text-gray-500">Holidays</span>
                                    <span class="font-bold text-teal-600 bg-teal-100 px-2 py-0.5 rounded-full text-xs">${leaveCounts[name].holidays}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                };


                const setupLeaveListener = () => {
                    const leavesCollection = collection(db, leavesCollectionPath);
                    onSnapshot(leavesCollection, (snapshot) => {
                        leaves = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderCalendar();
                        renderLeaveSummary();
                        if (calendarLoadingOverlay) calendarLoadingOverlay.style.display = 'none';
                    }, (error) => {
                        console.error("Error fetching leaves:", error);
                        let errorMsg = 'Failed to sync with the database.';
                        if (error.code === 'permission-denied') {
                            errorMsg = 'Permission Denied. Please check your Firestore security rules in the Firebase Console.';
                        }
                        showMessage(errorMsg, 'error');
                        if (calendarLoadingOverlay) calendarLoadingOverlay.innerHTML = `<p class="text-red-600 font-semibold text-center">${errorMsg}</p>`;
                    });
                };

                const renderCalendar = () => {
                    calendarGrid.innerHTML = ''; 
                    const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
                    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                    monthYearDisplay.textContent = `${new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' })} ${currentYear}`;

                    for (let i = 0; i < firstDayOfMonth; i++) {
                        calendarGrid.insertAdjacentHTML('beforeend', '<div class="day-cell"></div>');
                    }

                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(currentYear, currentMonth, day);
                        const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const leavesOnThisDay = leaves.filter(l => l.leaveDate === dateString);

                        let dayClasses = 'calendar-day border border-gray-200 rounded-lg p-1.5 min-h-[80px] sm:min-h-[100px] text-xs sm:text-sm flex flex-col transition duration-200 ease-in-out';
                        let dayNumberClasses = 'font-semibold mb-1 text-gray-700';

                        if (leavesOnThisDay.length >= 3) {
                            dayClasses += ' bg-rose-400 text-white';
                        } else if (leavesOnThisDay.length === 2) {
                            dayClasses += ' bg-amber-200 text-amber-900';
                        } else if (leavesOnThisDay.length === 1) {
                            dayClasses += ' bg-sky-100 text-sky-800';
                        } else {
                            dayClasses += ' bg-white hover:bg-gray-50';
                        }
                        
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        if (date.getTime() === today.getTime()) {
                            dayNumberClasses = 'font-bold bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center mb-1';
                        }

                        let employeeListHTML = leavesOnThisDay.map(leave => `
                            <div class="employee-entry group relative flex items-center justify-between text-xs font-medium bg-white/70 px-1.5 py-0.5 rounded-md mt-1 hover:bg-gray-100" 
                                data-id="${leave.id}" data-name="${leave.employeeName}" data-date="${leave.leaveDate}" data-type="${leave.leaveType}">
                                <span class="truncate">${leave.employeeName}</span>
                                <span class="ml-1 font-bold text-slate-700 bg-slate-200 rounded-full px-1.5 text-[10px]">${leave.leaveType}</span>
                                <button class="delete-btn opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700 transition" data-id="${leave.id}">
                                    <svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>`
                        ).join('');

                        const dayHTML = `<div class="${dayClasses}" data-date="${dateString}"><div class="${dayNumberClasses}">${day}</div>${employeeListHTML}</div>`;
                        calendarGrid.insertAdjacentHTML('beforeend', dayHTML);
                    }
                };
                
                const resetForm = () => {
                    form.reset();
                    editingLeave = null;
                    formTitle.textContent = 'Request Leave';
                    submitButton.textContent = 'Submit Request';
                    nameInput.disabled = false;
                    cancelButton.classList.add('hidden');
                };
                
                const handleFormSubmit = async (event) => {
                    event.preventDefault();
                    let name = nameInput.value.trim();
                    const newDate = dateInput.value;
                    const leaveType = leaveTypeInput.value;

                    if (!name || !newDate || !leaveType) {
                        showMessage('Please fill out all fields.', 'error'); return;
                    }

                    const formattedName = name.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');

                    const addLeaveAction = async () => {
                        try {
                            await addDoc(collection(db, leavesCollectionPath), { employeeName: formattedName, leaveDate: newDate, leaveType: leaveType });
                            showMessage('Leave request submitted!', 'success');
                            resetForm();
                        } catch (error) {
                            console.error("Error adding document: ", error);
                            showMessage('Failed to submit leave.', 'error');
                        }
                    };

                    const updateLeaveAction = async () => {
                        try {
                            const leaveDocRef = doc(db, leavesCollectionPath, editingLeave.id);
                            await updateDoc(leaveDocRef, { leaveDate: newDate, leaveType: leaveType });
                            showMessage('Leave updated!', 'success');
                            resetForm();
                        } catch (error) {
                            console.error("Error updating document: ", error);
                            showMessage('Failed to update leave.', 'error');
                        }
                    };

                    if (editingLeave) {
                        if (newDate === editingLeave.leaveDate && leaveType === editingLeave.leaveType) { resetForm(); return; }
                        if (leaves.filter(l => l.leaveDate === newDate && l.id !== editingLeave.id).length >= 2) {
                            showConfirmation('Capacity Warning', 'The new date is at capacity. Are you sure you want to move this leave?', updateLeaveAction);
                        } else {
                            await updateLeaveAction();
                        }
                    } else {
                        if (leaves.filter(l => l.leaveDate === newDate).length >= 2) {
                            showConfirmation('Capacity Warning', 'This date is at capacity. Are you sure you want to add another person?', addLeaveAction);
                        } else {
                            await addLeaveAction();
                        }
                    }
                };

                const handleCalendarClick = (event) => {
                    const deleteBtn = event.target.closest('.delete-btn');
                    const employeeEntry = event.target.closest('.employee-entry');

                    if (deleteBtn) {
                        const docId = deleteBtn.dataset.id;
                        const leaveToDelete = leaves.find(l => l.id === docId);
                        if (leaveToDelete) {
                            const deleteAction = async () => {
                                try {
                                    await deleteDoc(doc(db, leavesCollectionPath, docId));
                                    showMessage('Leave entry deleted.', 'success');
                                    if (editingLeave && editingLeave.id === docId) resetForm();
                                } catch (error) {
                                    console.error("Error deleting document: ", error);
                                    showMessage('Failed to delete leave.', 'error');
                                }
                            };
                            showConfirmation(
                                'Confirm Deletion', 
                                `Are you sure you want to delete the leave for ${leaveToDelete.employeeName} on ${leaveToDelete.leaveDate}?`, 
                                deleteAction
                            );
                        }
                    } else if (employeeEntry) {
                        editingLeave = leaves.find(l => l.id === employeeEntry.dataset.id);
                        if (editingLeave) {
                            formTitle.textContent = 'Update Leave';
                            submitButton.textContent = 'Update Request';
                            nameInput.value = editingLeave.employeeName;
                            nameInput.disabled = true;
                            dateInput.value = editingLeave.leaveDate;
                            leaveTypeInput.value = editingLeave.leaveType;
                            cancelButton.classList.remove('hidden');
                            nameInput.focus();
                        }
                    }
                };
                
                const handleCalendarMouseOver = (event) => {
                    const dayCell = event.target.closest('.calendar-day');
                    if (!dayCell) return;

                    const leavesOnDay = leaves.filter(l => l.leaveDate === dayCell.dataset.date);
                    if (leavesOnDay.length > 0) {
                        const date = new Date(dayCell.dataset.date + 'T00:00:00');
                        const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                        tooltip.innerHTML = `<h4 class="font-bold text-base mb-1 border-b border-gray-600 pb-1">${formattedDate}</h4><ul class="list-inside">${leavesOnDay.map(l => `<li class="py-1 flex justify-between"><span>${l.employeeName}</span> <span class="font-semibold bg-gray-600 px-1.5 rounded">${l.leaveType}</span></li>`).join('')}</ul>`;
                        tooltip.style.left = `${event.clientX + 15}px`;
                        tooltip.style.top = `${event.clientY + 15}px`;
                        tooltip.classList.add('visible');
                    }
                };
                
                const handleCalendarMouseOut = () => tooltip.classList.remove('visible');
                
                const handlePdfDownload = () => {
                    const { jsPDF } = window.jspdf;
                    const today = new Date();
                    const startRange = new Date(today.getFullYear(), today.getMonth(), 1);
                    const endRange = new Date(today.getFullYear(), today.getMonth() + 2, 0);

                    const leavesToDownload = leaves.filter(leave => {
                        const leaveDate = new Date(leave.leaveDate + 'T00:00:00');
                        return leaveDate >= startRange && leaveDate <= endRange;
                    });

                    if (leavesToDownload.length === 0) {
                        showMessage('No leaves for the current or next month to report.', 'error');
                        return;
                    }

                    const groupedLeaves = leavesToDownload.reduce((acc, leave) => {
                        if (!acc[leave.leaveDate]) {
                            const date = new Date(leave.leaveDate + 'T00:00:00');
                            acc[leave.leaveDate] = {
                                day: date.toLocaleDateString('en-US', { weekday: 'long' }),
                                details: []
                            };
                        }
                        acc[leave.leaveDate].details.push({ name: leave.employeeName, type: leave.leaveType });
                        return acc;
                    }, {});

                    const sortedDates = Object.keys(groupedLeaves).sort();

                    const tableBody = sortedDates.map(date => {
                        const { day, details } = groupedLeaves[date];
                        const employeesString = details.map(d => `${d.name} (${d.type})`).join(', ');
                        return [date, day, employeesString];
                    });

                    const doc = new jsPDF();
                    const currentMonthName = startRange.toLocaleString('default', { month: 'long' });
                    const nextMonthName = new Date(today.getFullYear(), today.getMonth() + 1, 1).toLocaleString('default', { month: 'long' });
                    const title = `Leave Report: ${currentMonthName} & ${nextMonthName} ${today.getFullYear()}`;
                    
                    doc.setFontSize(18);
                    doc.text(title, 14, 22);
                    doc.autoTable({
                        head: [["Date", "Day", "Employees on Leave"]],
                        body: tableBody,
                        startY: 30,
                        theme: 'striped',
                        headStyles: { fillColor: [30, 41, 59] }, // Slate 800
                        alternateRowStyles: { fillColor: [241, 245, 249] }, // Slate 100
                        didDrawPage: (data) => {
                            doc.setFontSize(10);
                            doc.text('Page ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                        }
                    });
                    doc.save(`leave_report_${currentMonthName}_${nextMonthName}.pdf`);
                };

                const showMessage = (message, type) => {
                    messageBox.innerHTML = '';
                    const color = type === 'success' ? 'text-green-600' : 'text-red-600';
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `${color} p-2 rounded-md bg-opacity-20 message-enter`;
                    messageDiv.textContent = message;
                    messageBox.appendChild(messageDiv);
                    requestAnimationFrame(() => messageDiv.classList.add('message-enter-active'));
                    setTimeout(() => {
                        messageDiv.style.opacity = '0';
                        messageDiv.style.transform = 'translateY(-10px)';
                        setTimeout(() => messageBox.innerHTML = '', 300);
                    }, 4000);
                };
                
                let confirmCallback = null;
                const showConfirmation = (title, message, onConfirm) => {
                    modalTitle.textContent = title;
                    modalMessage.textContent = message;
                    confirmationModal.classList.remove('hidden');
                    confirmCallback = onConfirm;
                };
                const hideConfirmation = () => {
                    confirmationModal.classList.add('hidden');
                    confirmCallback = null;
                };

                // --- AUTHENTICATION & INITIALIZATION ---
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        try {
                            console.log("User authenticated with UID:", user.uid);
                            leavesCollectionPath = `artifacts/${appId}/public/data/leaves`;
                            await seedInitialData();
                            setupLeaveListener();
                            if (formLoadingOverlay) formLoadingOverlay.style.display = 'none';
                        } catch (error) {
                            console.error("Firestore initialization failed:", error);
                            let errorMsg = 'Failed to load data.';
                            if (error.code === 'permission-denied') {
                                errorMsg = 'Permission Denied. Please check your Firestore security rules in the Firebase Console.';
                            }
                            showMessage(errorMsg, 'error');
                            if (formLoadingOverlay) formLoadingOverlay.innerHTML = `<p class="text-red-600 font-semibold">${errorMsg}</p>`;
                            if (calendarLoadingOverlay) calendarLoadingOverlay.innerHTML = `<p class="text-red-600 font-semibold text-center">${errorMsg}</p>`;
                        }
                    } else {
                        console.log("User not authenticated.");
                        if(formLoadingOverlay) formLoadingOverlay.innerHTML = '<p class="text-red-600 font-semibold">Connection Failed</p>';
                        if(calendarLoadingOverlay) calendarLoadingOverlay.innerHTML = '<p class="text-red-600 font-semibold">Connection Failed</p>';
                    }
                });
                
                try {
                    if (typeof __firebase_config !== 'undefined' && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    showMessage('Could not connect to the database. Check your Firebase config and security rules.', 'error');
                }
                
                // --- EVENT LISTENERS ---
                form.addEventListener('submit', handleFormSubmit);
                calendarGrid.addEventListener('click', handleCalendarClick);
                calendarGrid.addEventListener('mousemove', handleCalendarMouseOver);
                calendarGrid.addEventListener('mouseout', handleCalendarMouseOut);
                cancelButton.addEventListener('click', resetForm);
                downloadPdfButton.addEventListener('click', handlePdfDownload);
                modalConfirmBtn.addEventListener('click', () => {
                    if (confirmCallback) confirmCallback();
                    hideConfirmation();
                });
                modalCancelBtn.addEventListener('click', hideConfirmation);
                prevBtn.addEventListener('click', () => {
                    currentMonth--;
                    if (currentMonth < 0) { currentMonth = 11; currentYear--; }
                    renderCalendar();
                });
                nextBtn.addEventListener('click', () => {
                    currentMonth++;
                    if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                    renderCalendar();
                });
            }
        });
    </script>
</body>
</html>

