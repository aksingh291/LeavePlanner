<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Leave Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Libraries for PDF file generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for calendar day hover effect and message box animations */
        .calendar-day:not(.disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .message-enter {
            opacity: 0;
            transform: translateY(-10px);
        }
        .message-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms, transform 300ms;
        }
        .employee-entry {
            cursor: pointer;
        }
        #tooltip {
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            pointer-events: none; /* Prevents the tooltip from interfering with mouse events */
            transform: scale(0.95);
        }
        #tooltip.visible {
            opacity: 1;
            transform: scale(1);
        }
        /* Shake animation for form errors */
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-6px); }
          75% { transform: translateX(6px); }
        }
        .shake {
          animation: shake 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">

        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Team Leave Planner</h1>
            <p class="mt-2 text-md text-gray-600">Plan your team's time off. A maximum of two employees can take leave on the same day.</p>
        </header>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Leave Request Form -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-200 h-fit">
                <h2 id="formTitle" class="text-xl font-semibold mb-4 text-gray-800">Request Leave</h2>
                <form id="leaveForm" class="space-y-4">
                    <div>
                        <label for="employeeName" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                        <input type="text" id="employeeName" placeholder="Enter your full name" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition disabled:bg-gray-100">
                    </div>
                    <div>
                        <label for="leaveDate" class="block text-sm font-medium text-gray-700 mb-1">Leave Date</label>
                        <input type="date" id="leaveDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                    <div class="flex space-x-2">
                        <button type="submit" id="submitButton" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                            Submit Request
                        </button>
                        <button type="button" id="cancelButton" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition hidden">
                            Cancel
                        </button>
                    </div>
                </form>
                <!-- Message Box for notifications -->
                <div id="messageBox" class="mt-4 text-sm font-medium"></div>
            </div>

            <!-- Right Column: Calendar View -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-100 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h2 id="currentMonthYear" class="text-xl md:text-2xl font-bold text-gray-800 w-48 text-center"></h2>
                        <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-100 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div>
                        <button id="downloadButton" class="flex items-center space-x-2 bg-green-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span class="hidden sm:inline">Download Report</span>
                        </button>
                    </div>
                </div>
                
                <!-- Calendar Grid -->
                <div id="calendar-header" class="grid grid-cols-7 gap-2 text-center text-xs sm:text-sm font-semibold text-gray-500 mb-2">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-1 md:gap-2">
                    <!-- Calendar days will be dynamically generated here -->
                </div>
            </div>
        </main>
    </div>
    
    <!-- Tooltip for displaying names on hover -->
    <div id="tooltip" class="fixed opacity-0 z-10 p-3 bg-gray-800 text-white border border-gray-300 rounded-lg shadow-xl text-sm w-48"></div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                     <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Confirmation Required</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modalMessage" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3 space-x-2">
                    <button id="modalConfirmBtn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-auto hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Yes, Proceed
                    </button>
                    <button id="modalCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let currentDate = new Date();
            let currentMonth = currentDate.getMonth();
            let currentYear = currentDate.getFullYear();
            let editingLeave = null; 
            
            let leaves = JSON.parse(localStorage.getItem('teamLeaves')) || [
                { employeeName: 'Alex Johnson', leaveDate: `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-15` },
                { employeeName: 'Maria Garcia', leaveDate: `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-15` },
                { employeeName: 'David Smith', leaveDate: `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-20` }
            ];

            // --- DOM ELEMENT REFERENCES ---
            const form = document.getElementById('leaveForm');
            const formTitle = document.getElementById('formTitle');
            const nameInput = document.getElementById('employeeName');
            const dateInput = document.getElementById('leaveDate');
            const submitButton = document.getElementById('submitButton');
            const cancelButton = document.getElementById('cancelButton');
            const messageBox = document.getElementById('messageBox');
            const calendarGrid = document.getElementById('calendarGrid');
            const monthYearDisplay = document.getElementById('currentMonthYear');
            const prevBtn = document.getElementById('prevMonth');
            const nextBtn = document.getElementById('nextMonth');
            const downloadButton = document.getElementById('downloadButton');
            const tooltip = document.getElementById('tooltip');
            const confirmationModal = document.getElementById('confirmationModal');
            const modalMessage = document.getElementById('modalMessage');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');

            // --- CORE FUNCTIONS ---

            const saveLeaves = () => {
                localStorage.setItem('teamLeaves', JSON.stringify(leaves));
            };

            const renderCalendar = () => {
                calendarGrid.innerHTML = ''; 
                const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                monthYearDisplay.textContent = `${new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' })} ${currentYear}`;

                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarGrid.insertAdjacentHTML('beforeend', '<div class="day-cell"></div>');
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentYear, currentMonth, day);
                    const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const leavesOnThisDay = leaves.filter(l => l.leaveDate === dateString);

                    let dayClasses = 'calendar-day border border-gray-200 rounded-lg p-1.5 min-h-[80px] sm:min-h-[100px] text-xs sm:text-sm flex flex-col transition duration-200 ease-in-out';
                    let dayNumberClasses = 'font-semibold mb-1';

                    if (date < today) {
                        dayClasses += ' bg-gray-100 text-gray-400 disabled';
                    } else if (leavesOnThisDay.length >= 3) {
                        dayClasses += ' bg-red-500 text-white';
                    } else if (leavesOnThisDay.length === 2) {
                        dayClasses += ' bg-red-200 text-red-900';
                    } else if (leavesOnThisDay.length === 1) {
                        dayClasses += ' bg-yellow-100 text-yellow-800';
                    } else {
                        dayClasses += ' bg-green-50 text-green-800 hover:bg-green-100';
                    }
                    
                    if (date.getTime() === today.getTime()) {
                         dayNumberClasses += ' bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center';
                    } else {
                         dayNumberClasses += ' text-gray-700';
                    }

                    let employeeListHTML = leavesOnThisDay.map(leave => `
                        <div class="employee-entry group relative flex items-center justify-between text-xs font-medium bg-white/60 px-1.5 py-0.5 rounded-md mt-1 hover:bg-indigo-100" 
                            data-name="${leave.employeeName}" data-date="${leave.leaveDate}">
                            <span class="truncate">${leave.employeeName}</span>
                            <button class="delete-btn opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700 transition" data-name="${leave.employeeName}" data-date="${leave.leaveDate}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>`
                    ).join('');

                    const dayHTML = `
                        <div class="${dayClasses}" data-date="${dateString}">
                            <div class="${dayNumberClasses}">${day}</div>
                            ${employeeListHTML}
                        </div>`;
                    calendarGrid.insertAdjacentHTML('beforeend', dayHTML);
                }
            };
            
            const resetForm = () => {
                form.reset();
                editingLeave = null;
                formTitle.textContent = 'Request Leave';
                submitButton.textContent = 'Submit Request';
                nameInput.disabled = false;
                cancelButton.classList.add('hidden');
            };

            const handleFormSubmit = (event) => {
                event.preventDefault();
                const name = nameInput.value.trim();
                const newDate = dateInput.value;

                if (!name || !newDate) {
                    showMessage('Please fill out both fields.', 'error');
                    return;
                }
                const today = new Date();
                today.setHours(0,0,0,0);
                const selectedDate = new Date(newDate + 'T00:00:00');
                if (selectedDate < today) {
                    showMessage('Cannot book leave for a past date.', 'error');
                    return;
                }

                const addLeaveAction = () => {
                    leaves.push({ employeeName: name, leaveDate: newDate });
                    saveLeaves();
                    showMessage('Leave request submitted successfully!', 'success');
                    resetForm();
                    renderCalendar();
                };

                const updateLeaveAction = () => {
                    const leaveToUpdate = leaves.find(l => l.employeeName === editingLeave.employeeName && l.leaveDate === editingLeave.leaveDate);
                    if (leaveToUpdate) {
                        leaveToUpdate.leaveDate = newDate;
                        saveLeaves();
                        showMessage('Leave updated successfully!', 'success');
                        resetForm();
                        renderCalendar();
                    }
                };

                if (editingLeave) {
                    const isMovingToSameDate = newDate === editingLeave.leaveDate;
                    if (isMovingToSameDate) {
                        // No changes to make if date is the same
                        resetForm();
                        return;
                    }

                    const leavesOnNewDate = leaves.filter(l => l.leaveDate === newDate).length;
                    if (leavesOnNewDate >= 2) {
                        showConfirmation(
                            'The new date is at capacity (2+ employees). Are you sure you want to move this leave?',
                            updateLeaveAction
                        );
                    } else {
                        updateLeaveAction();
                    }
                } else {
                    const leavesOnDate = leaves.filter(l => l.leaveDate === newDate).length;
                    if (leavesOnDate >= 2) {
                        showConfirmation(
                            'This date is at capacity (2+ employees). Are you sure you want to add another person?',
                            addLeaveAction
                        );
                    } else {
                        addLeaveAction();
                    }
                }
            };

            const handleCalendarClick = (event) => {
                const deleteBtn = event.target.closest('.delete-btn');
                const employeeEntry = event.target.closest('.employee-entry');

                if (deleteBtn) {
                    const name = deleteBtn.dataset.name;
                    const date = deleteBtn.dataset.date;
                    const leaveIndex = leaves.findIndex(l => l.employeeName === name && l.leaveDate === date);

                    if (leaveIndex > -1) {
                        leaves.splice(leaveIndex, 1);
                        saveLeaves();
                        showMessage('Leave entry deleted.', 'success');
                        if (editingLeave && editingLeave.employeeName === name && editingLeave.leaveDate === date) {
                            resetForm();
                        }
                        renderCalendar();
                    }
                } else if (employeeEntry) {
                    const name = employeeEntry.dataset.name;
                    const date = employeeEntry.dataset.date;
                    
                    editingLeave = { employeeName: name, leaveDate: date };

                    formTitle.textContent = 'Update Leave';
                    submitButton.textContent = 'Update Request';
                    nameInput.value = name;
                    nameInput.disabled = true;
                    dateInput.value = date;
                    cancelButton.classList.remove('hidden');
                    nameInput.focus();
                }
            };
            
            const handleCalendarMouseOver = (event) => {
                const dayCell = event.target.closest('.calendar-day');
                if (!dayCell) return;

                const date = dayCell.dataset.date;
                const leavesOnDay = leaves.filter(l => l.leaveDate === date);

                if (leavesOnDay.length > 0) {
                    const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    const namesHTML = leavesOnDay.map(l => `<li class="py-1">${l.employeeName}</li>`).join('');
                    tooltip.innerHTML = `
                        <h4 class="font-bold text-base mb-1 border-b border-gray-600 pb-1">${formattedDate}</h4>
                        <ul class="list-disc list-inside">${namesHTML}</ul>`;
                    
                    const rect = dayCell.getBoundingClientRect();
                    tooltip.style.left = `${event.clientX + 15}px`;
                    tooltip.style.top = `${event.clientY + 15}px`;

                    tooltip.classList.add('visible');
                }
            };
            
            const handleCalendarMouseOut = () => {
                tooltip.classList.remove('visible');
            };

            const handleDownload = () => {
                const { jsPDF } = window.jspdf;
                const today = new Date();
                const startRange = new Date(today.getFullYear(), today.getMonth(), 1);
                const endRange = new Date(today.getFullYear(), today.getMonth() + 2, 0);

                const leavesToDownload = leaves.filter(leave => {
                    const leaveDate = new Date(leave.leaveDate + 'T00:00:00');
                    return leaveDate >= startRange && leaveDate <= endRange;
                }).sort((a, b) => new Date(a.leaveDate) - new Date(b.leaveDate));

                if (leavesToDownload.length === 0) {
                    showMessage('No leaves scheduled for the current or next month to download.', 'error');
                    return;
                }

                const doc = new jsPDF();
                
                const currentMonthName = startRange.toLocaleString('default', { month: 'long' });
                const nextMonthDate = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                const nextMonthName = nextMonthDate.toLocaleString('default', { month: 'long' });
                const year = today.getFullYear();
                
                const title = `Leave Report: ${currentMonthName} & ${nextMonthName} ${year}`;
                const filename = `leave_report_${currentMonthName.substring(0,3)}-${nextMonthName.substring(0,3)}_${year}.pdf`;

                doc.setFontSize(18);
                doc.text(title, 14, 22);

                const tableColumn = ["Employee Name", "Leave Date"];
                const tableRows = leavesToDownload.map(leave => [leave.employeeName, leave.leaveDate]);

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 30,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [22, 160, 133], // Teal
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [240, 248, 255] // Alice Blue
                    },
                });

                doc.save(filename);
            };

            const showMessage = (message, type) => {
                messageBox.innerHTML = '';
                const color = type === 'success' ? 'text-green-600' : 'text-red-600';
                const messageDiv = document.createElement('div');
                messageDiv.className = `${color} p-2 rounded-md bg-opacity-20 message-enter`;
                messageDiv.textContent = message;
                messageBox.appendChild(messageDiv);
                requestAnimationFrame(() => messageDiv.classList.add('message-enter-active'));
                setTimeout(() => {
                    messageDiv.style.opacity = '0';
                    messageDiv.style.transform = 'translateY(-10px)';
                    setTimeout(() => messageBox.innerHTML = '', 300);
                }, 4000);
            };

            // --- MODAL FUNCTIONS ---
            let confirmCallback = null;

            const showConfirmation = (message, onConfirm) => {
                modalMessage.textContent = message;
                confirmationModal.classList.remove('hidden');
                confirmCallback = onConfirm;
            };

            const hideConfirmation = () => {
                confirmationModal.classList.add('hidden');
                confirmCallback = null;
            };

            // --- EVENT LISTENERS ---
            form.addEventListener('submit', handleFormSubmit);
            calendarGrid.addEventListener('click', handleCalendarClick);
            calendarGrid.addEventListener('mousemove', handleCalendarMouseOver);
            calendarGrid.addEventListener('mouseout', handleCalendarMouseOut);
            cancelButton.addEventListener('click', resetForm);
            downloadButton.addEventListener('click', handleDownload);
            modalConfirmBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                hideConfirmation();
            });
            modalCancelBtn.addEventListener('click', hideConfirmation);


            prevBtn.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) { currentMonth = 11; currentYear--; }
                renderCalendar();
            });

            nextBtn.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                renderCalendar();
            });

            // --- INITIALIZATION ---
            const todayISO = new Date().toISOString().split('T')[0];
            dateInput.setAttribute('min', todayISO);
            renderCalendar();
        });
    </script>
</body>
</html>

